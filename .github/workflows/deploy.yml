name: Deploy Any App (Monorepo)

on:
  push:
    branches:
      - main

jobs:
  deploy-all:
    runs-on: ubuntu-latest
    name: Auto Deploy All Apps
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Deploy Detected Apps
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # ‡¶∏‡¶¨ ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞ ‡¶≤‡ßÅ‡¶™ ‡¶ï‡¶∞‡ßá ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶¨‡ßá
          for dir in */ ; do
            # ‡¶Ø‡¶¶‡¶ø ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞‡ßá‡¶∞ ‡¶≠‡ßá‡¶§‡¶∞ wrangler.toml ‡¶™‡¶æ‡ßü
            if [ -f "$dir/wrangler.toml" ]; then
              echo "üöÄ Found App in folder: $dir"
              
              # ‡¶´‡ßã‡¶≤‡ßç‡¶°‡¶æ‡¶∞‡ßá‡¶∞ ‡¶≠‡ßá‡¶§‡¶∞‡ßá ‡¶¢‡ßÅ‡¶ï‡¶¨‡ßá
              cd "$dir"
              
              # ‡¶°‡¶ø‡¶™‡ßá‡¶®‡ßç‡¶°‡ßá‡¶®‡ßç‡¶∏‡¶ø ‡¶á‡¶®‡¶∏‡ßç‡¶ü‡¶≤ ‡¶ï‡¶∞‡¶¨‡ßá
              if [ -f "package.json" ]; then
                npm install
              fi

              # ‡¶°‡¶ø‡¶™‡ßç‡¶≤‡ßü ‡¶ï‡¶∞‡¶¨‡ßá
              echo "üî• Deploying..."
              wrangler deploy --minify
              
              # ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶Æ‡ßá‡¶á‡¶® ‡¶°‡¶ø‡¶∞‡ßá‡¶ï‡ßç‡¶ü‡¶∞‡¶ø‡¶§‡ßá ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ü‡¶∏‡¶¨‡ßá ‡¶™‡¶∞‡ßá‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
              cd ..
              echo "‚úÖ Done: $dir"
              echo "-----------------------------------"
            fi
          done
